# AI4Stock 项目演进与核心逻辑记录 (Gemini CLI Context)

本文档由 Gemini 自动生成，用于记录 `AI4Stock` 项目的迭代历史、核心痛点解决过程以及回测指标演变，以便在长上下文中保持核心记忆。

## 🎯 核心目标
构建一个基于 LightGBM 的 A股日频量化模型，预测未来 20 天收益，每 10 天调仓。解决实盘中常见的数据泄漏、妖股污染、流动性幻觉和网络反爬等痛点。

---

## 🔄 版本演进历史

### V1：初始版本 (纯绝对收益赌妖股)
*   **特征**：基础量价（`ret_1~60`, `ma_ratio`, `volatility`）。
*   **标签 (Label)**：未来20天绝对收益 (`future_ret_20`)。
*   **回测逻辑**：等权买入 Top 20 股票，**无一字板过滤**。
*   **结果**：
    *   年化收益率：67.42%（极度失真）。
    *   **痛点暴露**：PnL 集中度极高（2024年亏损，全靠 Top1 救命赚回 200%+）。模型本质上在“赌妖股”，且在回测中买入了实盘无法成交的一字板股票。

### V2：防高波乌龟股版本 (Sharpe Label)
*   **特征**：同上。
*   **标签**：风险调整后收益 `future_ret_20 / future_std_20`。
*   **结果**：
    *   年化收益率：8.28%（白打工），夏普比率：0.26。
    *   **痛点暴露**：矫枉过正。模型为了追求高夏普（极小的分母），选出来的全是死水一潭、几乎不波动的“乌龟股”。换手率依然高达 20 倍，收益被交易磨损吃光。

### V3：抗污染超额收益版本 (中性化 + 剔除极值)
*   **特征**：同上。
*   **标签**：截面超额收益 (`future_ret_20` - 当日全市场平均收益)，结合 Huber Loss 训练。
*   **防污染机制 (核心突破)**：
    *   **训练端**：截面排名 (`rank`) 消除年份间的特征分布漂移；强制丢弃每天波动率排名前 1% 的股票，让模型“看不见”妖股。
    *   **回测端**：引入真实流动性约束（一字板 `High == Low` 拒绝买卖）。
    *   **交易端**：从等权买入改为**基于预测得分动态加权**（正分加权，负分空仓），单股上限 10%。
*   **结果**：
    *   年化收益率：29.58%，夏普比率：0.66。
    *   **痛点暴露**：虽然熊市防守极佳（自动空仓降仓），但 PnL 集中度依然夸张（2024年总赚3000，Top10赚25万）。模型依然偏向高弹性票。

### V4：Alpha158 高级特征版 (当前最新)
*   **特征大升级 (`gen_feature.py`)**：引入专业机构常用因子。
    *   `vwap_ratio`：真实资金成本偏离。
    *   `corr_cv_20`：量价相关性（区分放量涨与缩量跌）。
    *   `skew_20` & `kurt_20`：收益率高阶矩（偏度/峰度），识别暴涨暴雷体质。
    *   `rsi_14`, `macd_diff`, `atr_14` 等。
*   **回测增强**：增加 Trade Win Rate（交易胜率）统计。
*   **当前结果 (V4 运行数据)**：
    *   **Avg Annual Return**: 90.16%
    *   **Sharpe Ratio**: 0.62
    *   **Trade Win Rate**: 48.18%
    *   **2021**: +373% (牛市大爆发)
    *   **2023**: +2.0% (大熊市神奇逆转为正收益！)
    *   **2024**: +24.4% (震荡市表现优异)
    *   **点评**：引入高级量价特征后，模型终于在熊市（2023）和震荡市（2024）找到了真正的 Alpha，实现了全正收益年份。胜率 48% 配合高盈亏比，是非常典型的量化特征。

### V5：动态止盈止损版 (实验失败)
*   **交易逻辑尝试**：引入每日监控，`-8%` 止损，`+15%` 止盈。
*   **结果**：胜率下降至 44.8%，年化收益率暴跌至 8.57%。
*   **原因**：硬止盈（15%）在牛市中过早卖飞了核心阿尔法（妖股主升浪），硬止损频繁被市场正常的洗盘触发。这证明**对高弹性机器学习票使用固定阈值止盈止损是灾难性的**。

### V6：惰性换仓与缓冲区版 (当前最新)
*   **交易逻辑大升级 (`backtest_lgbm.py`)**：撤销了死板的 SL/TP 阈值。引入了**排名缓冲区 (Rank Buffer)**：
    *   买入：预测分为正，且排名前 20 (`TOP_N=20`)。
    *   持有：只要还在前 50 (`KEEP_TOP_N=50`) 且预测分依然为正，就继续持有，不盲目“掐尖”换仓。
*   **结果 (V6 运行数据)**：
    *   **Avg Annual Return**: 89.97%
    *   **Sharpe Ratio**: 0.63
    *   **Trade Win Rate**: 47.78%
    *   **Turnover 下降**：各年份换手率普遍下降（如 2021 年从 15.5 降至 12.3）。
    *   **点评**：成功找回了被止盈卖飞的利润（2021牛市暴赚 370%），同时通过减少无效换手，在 2022、2024 年震荡市取得了超越之前所有版本的优秀成绩。

### V7：终极数据管线版 (当前最新)
*   **架构大统一 (`data_pipeline.py`)**：整合了原本分散的行情抓取、估值抓取和数据融合脚本。
*   **全量后复权 (HFQ)**：行情抓取全面转向**后复权 (hfq)** 模式，并从**上市首日**开始拉取全历史数据。彻底解决了前复权导致的负价格问题及历史数据随分红变动的风险。
*   **估值融合**：自动将每日 PE(TTM)、PB、PS 等基本面指标与量价数据执行 **Outer Join** 融合，形成了覆盖全生命周期的原始数据底座。
*   **健壮性**：内置了失败日志输出 (`fetch_fails.log`)、自动熔断机制及极速元数据自检逻辑。

---

## 🏗️ 基础设施架构

### 1. 终极数据管线 (`data_pipeline.py`)
*   **双源自适应**：支持 `--hist` (东财) 和 `--sina` (新浪) 数据源，通过命令行参数一键切换。
*   **后复权全历史**：默认从 1990 年开始抓取，确保数据的连续性与不可变性（Immutable History）。
*   **自动融合引擎**：抓取完成后自动将量价层与估值层进行缝合，产出位于 `data/processed/combined` 的标准化数据。
*   **故障隔离**：支持 `fetch_fails.log` 记录所有异常 symbol，方便事后定向排查。

---

## 🏗️ 训练管线 (`train_lgbm.py`)
*   **数据隔离**：验证集使用最近 30 天可用数据，训练集与验证集之间加入 `GAP_DAYS=30` 绝对隔离，杜绝 Look-ahead bias。
*   **性能优化**：引入 `ProcessPoolExecutor` 多进程极速加载 Parquet 特征文件。

---

## 📌 下一步优化方向 (TODO)

1.  **惰性换仓 (Lazy Rebalancing)**：目前只要跌出 Top 20 就卖出。可以加入“缓冲池”概念（如：买入要求 Top 20，卖出要求跌出 Top 50），以进一步降低换手率。
2.  **大盘择时 (Market Timing)**：结合大盘指数（如沪深300 MA60），在系统性风险时强制压降总仓位上限。
3.  **超参数调优 (Hyperparameter Tuning)**：使用交叉验证为当前的 LightGBM 寻找更优的 `num_leaves` 和 `learning_rate`。